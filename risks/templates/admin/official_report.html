<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official Risk Report</title>
    <style>
        /* LANDSCAPE MODE */
        @page { size: A4 landscape; margin: 0.5cm; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: #000; 
            padding: 20px; 
            width: 100%; 
            margin: 0 auto; 
        }
        
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 25px; }
        .logo-text { font-size: 24px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
        .sub-text { font-size: 14px; color: #333; margin-top: 5px; font-weight: bold; }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
        th, td { border: 1px solid #444; padding: 6px; text-align: left; vertical-align: middle; }
        
        /* EDIT MODE STYLES */
        .editable-active td { cursor: text; border: 1px dashed #2196f3; }
        .editable-active td:focus { background-color: #e3f2fd; outline: none; }
        
        /* HEADER COLORS */
        .col-id { background-color: #f0f0f0; width: 3%; }
        .col-category { background-color: #f0f0f0; width: 8%; }
        .col-desc { background-color: #f0f0f0; width: 15%; }
        
        /* --- UPDATED COLORS START HERE --- */
        
        /* 1. LIKELIHOOD - Grey */
        .col-likelihood { background-color: #808080 !important; color: white; width: 5%; text-align: center; }
        
        /* 2. IMPACT - Lemon Green */
        .col-impact { background-color: #ADFF2F !important; color: black; width: 5%; text-align: center; }
        
        /* 3. RISK RANK - Orange (Kept as before) */
        .col-rank { background-color: #FFA500 !important; color: black; font-weight: bold; width: 5%; text-align: center; }
        
        /* 4. RISK TRIGGER - Red */
        .col-trigger { background-color: #FF0000 !important; color: white; width: 12%; }
        
        /* --- UPDATED COLORS END HERE --- */

        .col-residual { background-color: #006400 !important; color: white; font-weight: bold; width: 9%; text-align: center; }

        /* SIGNATURE STYLES */
        .signatures { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 80px; 
            page-break-inside: avoid; 
        }
        .sig-block { 
            width: 30%; 
            border-top: 1px solid #000; 
            padding-top: 10px; 
            text-align: center; 
            font-size: 14px; 
            font-weight: bold; 
        }

        /* BUTTONS */
        .btn-container { text-align: right; margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; font-size: 12px; transition: all 0.3s ease; }
        
        .btn-edit { background-color: #ff9800; color: white; }
        .btn-excel { background-color: #2e7d32; color: white; }
        .btn-print { background-color: #007bff; color: white; }
        
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn.active { background-color: #e65100; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }

        /* ADMIN EDIT BOX */
        .admin-controls { background: #e3f2fd; padding: 10px; border: 1px solid #2196f3; margin-bottom: 15px; border-radius: 5px; }
        textarea { width: 100%; height: 60px; padding: 5px; font-family: inherit; font-size: 12px; }

        @media print {
            .btn-container, .admin-controls { display: none; }
            body { padding: 0; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .editable-active td { border: 1px solid #444 !important; }
        }
    </style>
    
    <script>
        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
            filename = filename?filename+'.xls':'excel_data.xls';
            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            
            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], { type: dataType });
                navigator.msSaveOrOpenBlob( blob, filename);
            }else{
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                downloadLink.download = filename;
                downloadLink.click();
            }
        }

        function toggleEditMode() {
            var table = document.getElementById("riskTable");
            var btn = document.getElementById("editBtn");
            var isEditable = table.contentEditable === "true";

            if (isEditable) {
                table.contentEditable = "false";
                table.classList.remove("editable-active");
                btn.innerHTML = "‚úèÔ∏è ENABLE EDITING";
                btn.classList.remove("active");
                alert("Editing Disabled. You can now Print or Export.");
            } else {
                table.contentEditable = "true";
                table.classList.add("editable-active");
                btn.innerHTML = "üíæ FINISH EDITING";
                btn.classList.add("active");
                alert("üìù EDIT MODE ACTIVE\n\nClick any cell to change the text.\nChanges will appear in Excel & Print.\n(Note: Changes are temporary and not saved to database)");
            }
        }
    </script>
</head>
<body>

    <div class="btn-container">
        <button id="editBtn" onclick="toggleEditMode()" class="btn btn-edit">‚úèÔ∏è ENABLE EDITING</button>
        <button onclick="exportTableToExcel('riskTable', 'Risk_Report_Export')" class="btn btn-excel">üì• EXPORT TO EXCEL</button>
        <button onclick="window.print()" class="btn btn-print">üñ®Ô∏è PRINT REPORT</button>
    </div>

    <div class="header">
        <div class="logo-text">Bank Risk Management System</div>
        <div class="sub-text">Official Risk Register Report</div>
        <div class="sub-text" style="font-size: 12px; color: #555;">Generated: {{ generated_at|date:"Y-m-d H:i" }} | User: {{ generated_by }}</div>
    </div>

    {% if is_admin %}
        <form method="POST" class="admin-controls">
            {% csrf_token %}
            <label style="font-weight:bold; display:block; margin-bottom:5px;">‚úèÔ∏è Executive Summary (Admin):</label>
            <textarea name="executive_summary">{{ config.executive_summary }}</textarea>
            <div style="text-align:right; margin-top:5px;">
                <button type="submit" class="btn" style="background:#2196f3; color:white;">üíæ Save Summary</button>
            </div>
        </form>
    {% else %}
        <p style="font-size:12px; margin-bottom:20px;">{{ config.executive_summary }}</p>
    {% endif %}

    <table id="riskTable">
        <thead>
            <tr>
                <th class="col-id">ID</th>
                <th class="col-category">Risk Category</th>
                <th class="col-desc">Risk Description</th>
                <th class="col-likelihood">Likelihood</th>
                <th class="col-impact">Impact</th>
                <th class="col-rank">Risk Rank</th>
                <th class="col-trigger">Risk Trigger (Root Cause)</th>
                <th class="col-controls">Prevention Controls</th>
                <th class="col-treatment">Risk Treatment</th>
                <th class="col-owner">Risk Owner</th>
                <th class="col-coordinator">Coordinator</th>
                <th class="col-residual">Residual Risk</th>
            </tr>
        </thead>
        <tbody>
            {% for risk in risks %}
            <tr>
                <td style="font-weight:bold;">{{ risk.reference_id }}</td>
                <td>{{ risk.area_name }}</td>
                <td>{{ risk.description }}</td>
                
                <td class="col-likelihood" style="border: 1px solid #fff;">{{ risk.inherent_probability }}</td>
                <td class="col-impact" style="border: 1px solid #000;">{{ risk.inherent_impact }}</td>
                <td class="col-rank" style="border: 1px solid #000;">{{ risk.inherent_rating }}</td>
                <td class="col-trigger" style="border: 1px solid #000;">{{ risk.caused_by }}</td>
                
                <td>{{ risk.control_description|default:"Standard Controls" }}</td>
                <td>Mitigate</td>
                <td>{{ risk.risk_owner }}</td>
                <td>{{ risk.risk_coordinator|default:"-" }}</td>
                
                <td class="col-residual" style="border: 1px solid #fff;">{{ risk.residual_rating }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="12" style="text-align:center; padding: 20px;">No risks recorded.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="signatures">
        <div class="sig-block">
            Chief Risk Officer
            <br><small style="font-weight: normal;">(Sign & Date)</small>
        </div>
        <div class="sig-block">
            Internal Auditor
            <br><small style="font-weight: normal;">(Sign & Date)</small>
        </div>
        <div class="sig-block">
            Board Chairman
            <br><small style="font-weight: normal;">(Sign & Date)</small>
        </div>
    </div>

</body>
</html>